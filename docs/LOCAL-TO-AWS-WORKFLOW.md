# ربط المشروع المحلي بالسيرفر على AWS

الفكرة: **تشتغل على المشروع عندك لوكال، والسيرفر يحدّث نفسه بالتغييرات** (إما يدوياً بأمر واحد، أو تلقائياً عبر Git).

---

## طريقتان رئيسيتان

### 1) عبر Git (أنسب للإنتاج وأبسط)

- **عندك (لوكال):** تعدّل الكود → ترفع التعديلات لـ Git.
- **على السيرفر:** يسحب آخر تعديلات ويبني ويشغّل من جديد.

**المميزات:** آمن، نسخ محفوظة، تعمل من أي جهاز.  
**العيوب:** تحتاج تنفّذ خطوة على السيرفر بعد كل `push` (يدوياً أو بأتمتة).

**كيف يسمع السيرفر؟**
- **يدوياً:** بعد ما تعمل `git push` تدخل على EC2 وتشغّل سكربت تحديث واحد (انظر أسفل).
- **شبه تلقائي:** من جهازك تشغّل سكربت واحد يعمل `push` ثم يتصل بالسيرفر ويشغّل السكربت (انظر "سكربت من جهازك" أسفل).
- **تلقائي كامل:** بعد الـ push، السيرفر يسحب ويحدّث نفسه (مثلاً عبر GitHub Actions أو webhook على EC2).

---

### 2) مزامنة ملفات مباشرة (rsync)

- أي تغيير تحفظه محلياً يُنسخ فوراً (أو بأمر) إلى مجلد المشروع على EC2.
- على EC2 تشغّل `npm run dev` أو تعيد تشغيل التطبيق بعد المزامنة.

**المميزات:** السيرفر يرى التعديلات بسرعة، مفيد لتجربة سريعة.  
**العيوب:** تحتاج مفتاح SSH وتهيئة، ولو شغّلت `dev` على السيرفر فاستهلاك موارد أعلى.

**مثال مزامنة يدوية (من PowerShell على ويندوز):**
```powershell
# مرة واحدة: ثبّت rsync (مثلاً عبر Chocolatey: choco install rsync)
# ثم من مجلد المشروع:
rsync -avz --exclude node_modules --exclude .next --exclude .git -e "ssh -i مسار\مفتاحك.pem" . ec2-user@عنوان-EC2:~/MerasNode/
```

---

## ما الذي نضبطه هنا؟

سنركّز على **الطريقة 1 (Git)** لأنها الأنسب لرفع المشروع كله على AWS وربط اللوكال بالسيرفر:

1. **سكربت على السيرفر (EC2):** يسحب من Git، يثبّت الحزم، يبني، ويعيد تشغيل التطبيق (pm2).
2. **سكربت من جهازك (اختياري):** يعمل `git push` ثم يتصل بـ EC2 ويشغّل سكربت التحديث — فـ "لما اشتغل لوكال" وتنتهي من التعديلات، تشغّل أمر واحد فيصبح السيرفر محدّث.

---

## الخطوات العملية

### على السيرفر (EC2) — مرة واحدة

1. تثبيت المشروع وتهيئته كما في [AWS-DEPLOY-STEPS.md](./AWS-DEPLOY-STEPS.md) (Node 20، `whatsapp-service`، pm2، إلخ).
2. نسخ سكربت التحديث وتشغيله:
   - السكربت موجود في المشروع: `scripts/deploy-on-ec2.sh`
   - انسخه إلى EC2 أو تأكد أن المشروع مأخوذ من Git فيحتوي عليه.
   - على EC2:
     ```bash
     chmod +x ~/MerasNode/scripts/deploy-on-ec2.sh
     ```
   - للتحديث يدوياً بعد أي `git push`:
     ```bash
     cd ~/MerasNode && ./scripts/deploy-on-ec2.sh
     ```

### من جهازك (لوكال) — كل ما تريد تحديث السيرفر

**الإعداد مرة واحدة:** راجع [قائمة الإعداد (SETUP-DEPLOY-CHECKLIST.md)](./SETUP-DEPLOY-CHECKLIST.md) لإنشاء `deploy.local.ps1` وضبط عنوان السيرفر ومفتاح SSH.

**الطريقة بأمر واحد (مفضّلة):**
من PowerShell في مجلد المشروع:
```powershell
.\scripts\deploy-from-local.ps1
```
السكربت يرفع التعديلات إلى Git ثم يتصل بـ EC2 ويشغّل `deploy-on-ec2.sh` — فيصبح السيرفر محدّثاً.

**الطريقة اليدوية:** push ثم على EC2:
```bash
cd ~/MerasNode && ./scripts/deploy-on-ec2.sh
```

---

## ملخص

| هدفك | ما تفعله |
|------|----------|
| رفع المشروع كله على AWS | اتبع [AWS-DEPLOY-STEPS.md](./AWS-DEPLOY-STEPS.md). |
| ربط اللوكال بالسيرفر بحيث "لما اشتغل لوكال يسمع على السيرفر" | اعتمد Git: عدّل لوكال → `git push` → على السيرفر شغّل `./scripts/deploy-on-ec2.sh` (أو استخدم `deploy-from-local.ps1` ليقوم بالـ push + تشغيل السكربت على EC2 من جهازك). |
| مزامنة فورية للتحقق على السيرفر | استخدم rsync كما في الطريقة 2 أعلاه. |

بهذا يكون المشروع مربوطاً بالسيرفر: التطوير لوكال، والسيرفر يحدّث نفسه عند الـ push ثم تشغيل سكربت التحديث.
