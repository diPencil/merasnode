# تشغيل النظام: إضافة رقم واتساب والإرسال والاستقبال

## الخطوة 1: تشغيل النظام

من مجلد المشروع (نفس مكان `package.json`):

```bash
npm run dev
```

أو إذا كنت تستخدم pnpm:

```bash
pnpm run dev
```

انتظر حتى تظهر في الطرفية:
- **Next.js** يعمل على: `http://localhost:3000`
- **WhatsApp Service** يعمل على: `http://localhost:3001`

اترك الطرفية مفتوحة ولا تغلقها.

---

## الخطوة 2: إضافة رقم واتساب وربطه

### 2.1 فتح التطبيق
- افتح المتصفح وادخل على: **http://localhost:3000**
- سجّل الدخول إذا طُلب منك.

### 2.2 إضافة حساب واتساب
1. اذهب إلى **حسابات واتساب** (أو **WhatsApp Accounts**).
   - من القائمة: قد تكون تحت "الإعدادات" أو "Integrations" أو من الرابط: `http://localhost:3000/whatsapp/accounts`
2. اضغط **ربط حساب** أو **Connect Account**.
3. اختر **WhatsApp Web** (ليس Meta Cloud).
4. اكتب **اسم الحساب** (مثلاً: دعم العملاء) و**رقم الهاتف** (مثلاً: 201003778273 بدون +).
5. اضغط **Generate QR Code** أو **إنشاء رمز QR**:
   - إذا لم يكن الحساب مضافة: سيتم إنشاء الحساب أولاً ثم ظهور الـ QR.
   - إذا الحساب موجود: اضغط **Link** بجانب الحساب في الجدول ثم امسح الـ QR.

### 2.3 مسح الـ QR من الموبايل
1. افتح **واتساب** على الموبايل.
2. الإعدادات (أو القائمة) → **الأجهزة المرتبطة** → **ربط جهاز**.
3. امسح الـ QR الظاهر على الشاشة.
4. انتظر حتى تظهر في النظام **Connected** أو **متصل**.

**بديل:** يمكنك فتح ملف **qr-display.html** من مجلد المشروع في المتصفح لعرض رموز QR لجميع الحسابات المضافة.

---

## الخطوة 3: استقبال الرسائل

بعد ربط الحساب بنجاح:
- الرسائل الواردة على هذا الرقم تظهر تلقائياً في **صندوق الوارد (Inbox)** في التطبيق.
- افتح **Inbox** من القائمة واختر المحادثة لرؤية الرسائل.

لا تحتاج تفعيل إضافي للاستقبال طالما الحساب يظهر **Connected**.

---

## الخطوة 4: إرسال الرسائل

### من الواجهة (Inbox)
1. اذهب إلى **Inbox**.
2. اختر محادثة (أو ابدأ محادثة مع جهة اتصال).
3. اكتب الرسالة واضغط إرسال.

### من سكربت تجريبي (للتأكد أن الإرسال شغال)
من مجلد المشروع:

```bash
node send-test-message.js
```

السكربت يرسل رسالة تجريبية من أول حساب متصل. غيّر رقم الاختبار داخل الملف إذا أردت (مثلاً رقمك الشخصي).

### من API مباشرة (للمطورين)
```http
POST http://localhost:3001/send
Content-Type: application/json

{
  "accountId": "معرف-الحساب-من-قاعدة-البيانات",
  "phoneNumber": "201003778273",
  "message": "مرحبا، هذه رسالة تجريبية"
}
```

---

## التحقق من أن كل شيء شغال

شغّل فحص النظام:

```bash
node verify-all.js
```

يفحص:
- أن تطبيق Next.js يعمل.
- أن خدمة الواتساب تعمل.
- أن قاعدة البيانات متصلة.

لو عندك حساب متصل وتريد تجربة الإرسال من السكربت:

```bash
node verify-all.js --send
```

---

## ملخص سريع

| المطلوب | ماذا تفعل |
|--------|------------|
| **تشغيل النظام** | `npm run dev` أو `pnpm run dev` |
| **إضافة رقم** | من واجهة "حسابات واتساب" → ربط حساب → اسم + رقم → Generate QR |
| **ربط الرقم** | امسح الـ QR من واتساب على الموبايل (الأجهزة المرتبطة → ربط جهاز) |
| **استقبال** | افتح Inbox في التطبيق، الرسائل تظهر تلقائياً |
| **إرسال** | من Inbox أو `node send-test-message.js` أو API الـ send |
| **التأكد** | `node verify-all.js` |

---

## إذا واجهت مشكلة

- **الحساب يظهر Disconnected رغم الربط على الموبايل:** اضغط **Refresh Status** في صفحة تكامل واتساب، أو أعد تشغيل `npm run dev` ثم انتظر قليلاً واضغط Refresh مرة أخرى.
- **لا يظهر QR:** تأكد أن خدمة الواتساب شغالة (البورت 3001) وأنك ضغطت Connect WhatsApp أو Link.
- **الإرسال لا يعمل:** تأكد أن الحساب يظهر **Connected** وأنك تستخدم `accountId` الصحيح ورقم المستلم بصيغة صحيحة (مثلاً 201003778273).

للفحص الشامل: `node verify-all.js` أو `node final-check.js`.
